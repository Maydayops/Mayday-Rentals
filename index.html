<script>
    window.onload = function() {
        let requiredFields = ["equipment", "rentalDuration", "startDate", "name", "email", "phone"];

        // Check if any valid form data exists (ensures empty fields don't trigger agreementViewed)
        let hasSavedData = requiredFields.some(field => {
            let value = localStorage.getItem(field);
            return value && value.trim() !== "";
        });

        if (!hasSavedData) {
            localStorage.removeItem("agreementViewed"); // Reset agreement if no valid form data
        }

        // Restore saved form data ONLY if valid saved data exists
        requiredFields.forEach(field => {
            let value = localStorage.getItem(field) || "";
            document.getElementById(field).value = value;
        });

        // Only show "already viewed" message if valid form data exists
        if (localStorage.getItem("agreementViewed") === "true" && hasSavedData) {
            alert("Rental agreement was already viewed. Proceed with booking.");
        }
    };

    function viewAgreement() {
        let requiredFields = ["equipment", "rentalDuration", "startDate", "name", "email", "phone"];

        // Check if all required fields are filled out
        let allFieldsFilled = requiredFields.every(field => document.getElementById(field).value.trim() !== "");

        if (!allFieldsFilled) {
            alert("Please fill out the booking form before viewing the agreement.");
            return;
        }

        // Save form data in localStorage
        requiredFields.forEach(field => {
            localStorage.setItem(field, document.getElementById(field).value);
        });

        // Mark agreement as viewed
        localStorage.setItem("agreementViewed", "true");

        // Open agreement in a new tab
        window.open("https://www.maydayops.com/equipment-rental-agreement-and-liability", "_blank");
    }

    document.getElementById("rentalForm").addEventListener("submit", function(event) {
        event.preventDefault();

        if (localStorage.getItem("agreementViewed") !== "true") {
            alert("You must view the rental agreement before proceeding.");
            return;
        }

        let rentalDuration = document.getElementById("rentalDuration").value;
        let startDate = document.getElementById("startDate").value;
        let equipment = document.getElementById("equipment").value;

        // Prevent double booking
        let existingBooking = localStorage.getItem("booked_" + equipment + "_" + startDate);
        if (existingBooking) {
            alert("This equipment is already booked for the selected start date. Please choose a different date.");
            return;
        }

        // Mark equipment as booked
        localStorage.setItem("booked_" + equipment + "_" + startDate, "true");

        // Wix Payment Links
        let paymentLinks = {
            "1 day - $350": "https://www.maydayops.com/_api/invoice/pay/20e53e3b-e3c8-4dcd-b295-186cc8ccc61f:6c900172-dba4-4d4c-ba26-92768d58dd37",
            "4 days - $800": "https://www.maydayops.com/_api/invoice/pay/20e53e3b-e3c8-4dcd-b295-186cc8ccc61f:34c17a4d-18e8-4eff-befa-f0c222523d8d"
        };

        let paymentURL = paymentLinks[rentalDuration];

        if (!paymentURL) {
            alert("Error: Payment link not found.");
            return;
        }

        alert("Redirecting to payment...");
        window.location.href = paymentURL;
    });

    // Fix Signature Pad for Mobile & Desktop
    let canvas = document.getElementById("signaturePad");
    let ctx = canvas.getContext("2d");
    let signing = false;

    function startSigning(x, y) {
        signing = true;
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    function sign(x, y) {
        if (!signing) return;
        ctx.lineTo(x, y);
        ctx.stroke();
    }

    function stopSigning() {
        signing = false;
    }

    canvas.addEventListener("mousedown", (e) => startSigning(e.offsetX, e.offsetY));
    canvas.addEventListener("mousemove", (e) => sign(e.offsetX, e.offsetY));
    canvas.addEventListener("mouseup", stopSigning);
    canvas.addEventListener("mouseleave", stopSigning);

    canvas.addEventListener("touchstart", (e) => {
        let touch = e.touches[0];
        let rect = canvas.getBoundingClientRect();
        startSigning(touch.clientX - rect.left, touch.clientY - rect.top);
    });

    canvas.addEventListener("touchmove", (e) => {
        let touch = e.touches[0];
        let rect = canvas.getBoundingClientRect();
        sign(touch.clientX - rect.left, touch.clientY - rect.top);
    });

    canvas.addEventListener("touchend", stopSigning);

    function clearSignature() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
</script>
